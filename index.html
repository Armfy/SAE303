<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAE303 AR Experience</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiError: yes;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"  vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-assets>
        <a-asset-item id="hat-model" src="./textures/hat.glb"></a-asset-item>
        <a-asset-item id="student-model" src="./textures/student.glb"></a-asset-item>
        <a-asset-item id="suit-model" src="./textures/suit.glb"></a-asset-item>
        <audio id="bg-music" src="./sounds/background.mp3" preload="auto"></audio>
      </a-assets>
      
      <a-entity sound="src: #bg-music; autoplay: true; loop: true; volume: 0.35"></a-entity>
      
      <a-camera position="0 0 0" look-controls="enabled: false">
        <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-entity>
      </a-camera>
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="welcome-bg" color="#000000" opacity="0.92" position="0 0 0.1" width="1.8" height="1" visible="false"></a-plane>
        <a-text id="welcome-title" value="Bienvenue sur le\ngraphique interactif" align="center" position="0 0.2 0.11" scale="0.35 0.35 0.35" color="#ffffff" visible="false"></a-text>
        <a-plane id="start-button" class="clickable" color="#FF5722" opacity="0.9" position="0 -0.15 0.11" width="0.8" height="0.2" visible="false"></a-plane>
        <a-text id="start-text" value="COMMENCER" align="center" position="0 -0.15 0.12" scale="0.3 0.3 0.3" color="#ffffff" visible="false"></a-text>
        
        <a-text value="EFFECTIFS" align="center" position="-0.4 0.55 0" scale="0.15 0.15 0.15" color="#FF5722" visible="false" id="sphere1-label"></a-text>
        <a-text value="STATUT" align="center" position="0.4 0.55 0" scale="0.15 0.15 0.15" color="#4CAF50" visible="false" id="sphere2-label"></a-text>
        
        <a-plane id="text-bg" color="#000000" opacity="0.9" position="0 0.85 -0.01" width="1.1" height="0.2" visible="false"></a-plane>
        <a-text value="Il y a 10 ans" align="center" position="0 0.85 0" scale="0.35 0.35 0.35" color="#ffffff" visible="false" id="title-text"></a-text>
        <a-plane id="number-bg" color="#000000" opacity="0.9" position="0 -0.4 -0.01" width="0.7" height="0.18" visible="false"></a-plane>
        <a-text value="2344" align="center" position="0 -0.4 0" scale="0.45 0.45 0.45" color="#FFC107" visible="false" id="number-text" font="roboto"></a-text>
        <a-sphere class="clickable" color="#FF5722" radius="0.15" position="-0.4 0.35 0" visible="false" id="scan-sphere" 
                  animation__hover="property: scale; to: 1.2 1.2 1.2; dur: 300; startEvents: mouseenter" 
                  animation__leave="property: scale; to: 1 1 1; dur: 300; startEvents: mouseleave"></a-sphere>
        <a-entity id="hat-entity" gltf-model="#hat-model" position="0 0 0.1" scale="0.05 0.05 0.05" visible="false"></a-entity>
        
        <a-sphere class="clickable" color="#4CAF50" radius="0.15" position="0.4 0.35 0" visible="false" id="status-sphere"
                  animation__hover="property: scale; to: 1.2 1.2 1.2; dur: 300; startEvents: mouseenter" 
                  animation__leave="property: scale; to: 1 1 1; dur: 300; startEvents: mouseleave"></a-sphere>
        <a-plane id="crowd-bg" color="#000000" opacity="0.92" position="0 0 0.05" width="2.8" height="1" visible="false"></a-plane>
        <a-text value="APPRENTIS vs NON-APPRENTIS" align="center" position="0 0.45 0.06" scale="0.25 0.25 0.25" color="#4CAF50" visible="false" id="crowd-title"></a-text>
        <a-entity id="crowd-container" position="0 -0.1 0.1" visible="false"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const targetEl = document.querySelector('[mindar-image-target]');
      const sphereEl = document.querySelector('#scan-sphere');
      const statusSphere = document.querySelector('#status-sphere');
      const sphere1Label = document.querySelector('#sphere1-label');
      const sphere2Label = document.querySelector('#sphere2-label');
      const hatEntity = document.querySelector('#hat-entity');
      const titleText = document.querySelector('#title-text');
      const textBg = document.querySelector('#text-bg');
      const numberText = document.querySelector('#number-text');
      const numberBg = document.querySelector('#number-bg');
      const crowdContainer = document.querySelector('#crowd-container');
      const crowdBg = document.querySelector('#crowd-bg');
      const crowdTitle = document.querySelector('#crowd-title');
      const welcomeBg = document.querySelector('#welcome-bg');
      const welcomeTitle = document.querySelector('#welcome-title');
      const startButton = document.querySelector('#start-button');
      const startText = document.querySelector('#start-text');
      
      let animationRunning = false;
      let statusAnimationRunning = false;
      let menuActive = false;

      const showElement = (el, animation) => {
        el.setAttribute('visible', true);
        if (animation) el.setAttribute('animation', animation);
      };
      
      const hideElement = (el) => el.setAttribute('visible', false);
      
      const showSpheres = () => {
        showElement(sphereEl, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
        showElement(statusSphere, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
        showElement(sphere1Label);
        showElement(sphere2Label);
      };
      
      const hideSpheres = () => {
        hideElement(sphereEl);
        hideElement(statusSphere);
        hideElement(sphere1Label);
        hideElement(sphere2Label);
      };
      
      targetEl.addEventListener('targetFound', () => {
        if (!menuActive) {
          showElement(welcomeBg, 'property: opacity; from: 0; to: 0.92; dur: 500');
          showElement(welcomeTitle, 'property: opacity; from: 0; to: 1; dur: 500');
          showElement(startButton, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
          showElement(startText, 'property: opacity; from: 0; to: 1; dur: 500');
        } else {
          showSpheres();
        }
      });
      
      targetEl.addEventListener('targetLost', () => {
        [sphereEl, statusSphere, sphere1Label, sphere2Label, titleText, textBg, numberText, 
         numberBg, crowdContainer, crowdBg, crowdTitle, welcomeBg, welcomeTitle, startButton, startText]
          .forEach(hideElement);
      });
      
      startButton.addEventListener('click', () => {
        menuActive = true;
        [welcomeBg, welcomeTitle, startButton, startText].forEach(hideElement);
        showSpheres();
      });
      
      sphereEl.addEventListener('click', () => {
        if (animationRunning) return;
        animationRunning = true;
        
        hideSpheres();
        showElement(textBg, 'property: opacity; from: 0; to: 0.9; dur: 500');
        showElement(titleText, 'property: opacity; from: 0; to: 1; dur: 500');
        showElement(numberBg, 'property: opacity; from: 0; to: 0.9; dur: 500');
        showElement(numberText, 'property: opacity; from: 0; to: 1; dur: 500');
        showElement(hatEntity);
        hatEntity.setAttribute('scale', '0.05 0.05 0.05');
        hatEntity.setAttribute('animation', 'property: scale; to: 0.23 0.23 0.23; dur: 2000; easing: easeOutQuad');
        
        setTimeout(() => {
          titleText.setAttribute('value', 'Il y a 5 ans');
          numberText.setAttribute('value', '2758');
          hatEntity.setAttribute('animation', 'property: scale; to: 0.43 0.43 0.43; dur: 2000; easing: easeOutQuad');
        }, 3000);
        
        setTimeout(() => {
          titleText.setAttribute('value', 'Maintenant');
          numberText.setAttribute('value', '2747');
          hatEntity.setAttribute('animation', 'property: scale; to: 0.6 0.6 0.6; dur: 2000; easing: easeOutQuad');
        }, 6000);
        
        setTimeout(() => {
          [hatEntity, titleText, textBg, numberText, numberBg].forEach(hideElement);
          showSpheres();
          animationRunning = false;
        }, 10000);
      });
      
      statusSphere.addEventListener('click', () => {
        if (statusAnimationRunning) return;
        statusAnimationRunning = true;
        
        hideSpheres();
        showElement(crowdBg, 'property: opacity; from: 0; to: 0.95; dur: 500');
        showElement(crowdTitle, 'property: opacity; from: 0; to: 1; dur: 500');
        
        crowdContainer.innerHTML = '';
        showElement(crowdContainer);
        
        const positions = [-0.9, -0.3, 0.3, 0.9];
        positions.forEach((x, index) => {
          setTimeout(() => {
            const model = document.createElement('a-entity');
            const modelId = index === 3 ? '#suit-model' : '#student-model';
            model.setAttribute('gltf-model', modelId);
            model.setAttribute('position', `${x} 0 0`);
            model.setAttribute('scale', '0.25 0.25 0.25');
            model.setAttribute('animation', 'property: scale; from: 0 0 0; to: 0.25 0.25 0.25; dur: 800; easing: easeOutBack');
            crowdContainer.appendChild(model);
            
            // Add label above the model
            const label = document.createElement('a-text');
            const labelText = index === 3 ? 'APPRENTIS' : 'ETUDIANT';
            label.setAttribute('value', labelText);
            label.setAttribute('align', 'center');
            label.setAttribute('position', `${x} 0.35 0`);
            label.setAttribute('scale', '0.22 0.22 0.22');
            label.setAttribute('color', '#ffffff');
            label.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 800');
            crowdContainer.appendChild(label);
          }, index * 400);
        });
        
        setTimeout(() => {
          [crowdContainer, crowdBg, crowdTitle].forEach(hideElement);
          showSpheres();
          statusAnimationRunning = false;
        }, 6000);
      });
    </script>
  </body>
</html>