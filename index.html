<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAE303 AR Experience</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiError: yes;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"  vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-assets>
        <a-asset-item id="hat-model" src="./assets/textures/3D/hat.glb"></a-asset-item>
        <a-asset-item id="student-model" src="./assets/textures/3D/student.glb"></a-asset-item>
        <a-asset-item id="suit-model" src="./assets/textures/3D/suit.glb"></a-asset-item>
        <a-asset-item id="school-model" src="./assets/textures/3D/school.glb"></a-asset-item>
        <a-asset-item id="lock-model" src="./assets/textures/3D/lock.glb"></a-asset-item>
        <img id="graph-aprentis" src="./assets/textures/graph_aprentis.png">
        <img id="nombres" src="./assets/textures/nombres.png">
        <img id="unilist" src="./assets/textures/unilist.png">
        <img id="purple" src="./assets/textures/top/purple.png">
        <img id="ruffel" src="./assets/textures/top/ruffel.png">
        <img id="supexup" src="./assets/textures/top/supexup.png">
        <img id="rank" src="./assets/textures/rank.png">
        <audio id="bg-music" src="./assets/sounds/background.mp3" preload="auto"></audio>
      </a-assets>
      
      <a-entity sound="src: #bg-music; autoplay: true; loop: true; volume: 0.35"></a-entity>
      
      <a-camera position="0 0 0" look-controls="enabled: false">
        <a-entity cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-entity>
        <a-box position="0 0 -2" rotation="15 20 0" color="#4CC3D9" width="0.5" height="0.5" depth="0.5"></a-box>
      </a-camera>
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="welcome-bg" color="#1a5f6f" opacity="0.95" position="0 0 0.1" width="2" height="1.2" visible="false"></a-plane>
        <a-text id="welcome-title" value="L'ENSEIGNEMENT\nSUPERIEUR\nBITERROIS" align="center" position="0 0.35 0.11" scale="0.4 0.4 0.4" color="#ffffff" visible="false" font-weight="bold"></a-text>
        <a-text id="welcome-subtitle" value="2025 | 2026" align="center" position="0 0.12 0.11" scale="0.25 0.25 0.25" color="#7dd3d7" visible="false"></a-text>
        <a-plane id="start-button" class="clickable" color="#7dd3d7" opacity="1" position="0 -0.15 0.11" width="1" height="0.22" visible="false"></a-plane>
        <a-text id="start-text" value="DECOUVRIR" align="center" position="0 -0.15 0.12" scale="0.35 0.35 0.35" color="#1a5f6f" visible="false" font-weight="bold"></a-text>
        
        <a-plane id="text-bg" color="#000000" opacity="0.9" position="0 0.85 -0.01" width="1.3" height="0.25" visible="false"></a-plane>
        <a-text value="En 2015" align="center" position="0 0.85 0" scale="0.45 0.45 0.45" color="#ffffff" visible="false" id="title-text"></a-text>
        <a-plane id="number-bg" color="#000000" opacity="0.9" position="0 -0.4 -0.01" width="1.3" height="0.22" visible="false"></a-plane>
        <a-text value="Etudiants : 2344" align="center" position="0 -0.4 0" scale="0.55 0.55 0.55" color="#9ED5D8" visible="false" id="number-text" font="roboto"></a-text>
        <a-plane class="clickable" src="#nombres" width="0.5" height="0.5" position="0.4 0.2 0" visible="false" id="scan-sphere" transparent="true"
                  animation__hover="property: scale; to: 1.2 1.2 1.2; dur: 300; startEvents: mouseenter" 
                  animation__leave="property: scale; to: 1 1 1; dur: 300; startEvents: mouseleave"></a-plane>
        <a-entity id="hat-entity" gltf-model="#hat-model" position="0 0 0.1" scale="0.03 0.03 0.03" visible="false"></a-entity>

        <a-plane class="clickable" src="#graph-aprentis" width="0.35" height="0.35" position="0.3 -0.5 0" visible="false" id="status-sphere" transparent="true"
                  animation__hover="property: scale; to: 1.1 1.1 1.1; dur: 300; startEvents: mouseenter" 
                  animation__leave="property: scale; to: 1 1 1; dur: 300; startEvents: mouseleave"></a-plane>
        <a-plane class="clickable" src="#unilist" width="0.3" height="0.2" position="-0.3 -0.6 0" visible="false" id="school-sphere" transparent="true"
                  animation__hover="property: scale; to: 1.2 1.2 1.2; dur: 300; startEvents: mouseenter" 
                  animation__leave="property: scale; to: 1 1 1; dur: 300; startEvents: mouseleave"></a-plane>
        <a-plane class="clickable" src="#rank" width="0.45" height="0.45" position="-0.3 -0.1 0" visible="false" id="podium-sphere" transparent="true"
                  animation__hover="property: scale; to: 1.1 1.1 1.1; dur: 300; startEvents: mouseenter" 
                  animation__leave="property: scale; to: 1 1 1; dur: 300; startEvents: mouseleave"></a-plane>
        <a-plane id="crowd-bg" color="#000000" opacity="0.92" position="0 0 0.05" width="2.8" height="1" visible="false"></a-plane>
        <a-text value="APPRENTIS vs NON-APPRENTIS" align="center" position="0 0.45 0.06" scale="0.32 0.32 0.32" color="#f5e9d4" visible="false" id="crowd-title"></a-text>
        <a-entity id="crowd-container" position="0 -0.1 0.1" visible="false"></a-entity>
        <a-plane id="schools-bg" color="#000000" opacity="0.92" position="0 0 0.05" width="2.8" height="1" visible="false"></a-plane>
        <a-text value="LES ETABLISSEMENTS" align="center" position="0 0.45 0.06" scale="0.32 0.32 0.32" color="#f5e9d4" visible="false" id="schools-title"></a-text>
        <a-entity id="schools-container" position="0 0 0.1" visible="false"></a-entity>
        <a-plane id="podium-bg" color="#000000" opacity="0.92" position="0 0 0.05" width="2.8" height="1.5" visible="false"></a-plane>
        <a-text value="TOP DES ETABLISSEMENTS AVEC LE PLUS D'APPRENTIS" align="center" position="0 0.65 0.06" scale="0.28 0.28 0.28" color="#f5e9d4" visible="false" id="podium-title"></a-text>
        <a-entity id="podium-container" position="0 -0.1 0.1" visible="false"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      // =================================================================
      //
      // Configuration des éléments et des animations
      //
      // =================================================================

      const targetEl = document.querySelector('[mindar-image-target]');
      const sphereEl = document.querySelector('#scan-sphere');
      const statusSphere = document.querySelector('#status-sphere');
      const schoolSphere = document.querySelector('#school-sphere');
      const podiumSphere = document.querySelector('#podium-sphere');
      const hatEntity = document.querySelector('#hat-entity');
      const titleText = document.querySelector('#title-text');
      const textBg = document.querySelector('#text-bg');
      const numberText = document.querySelector('#number-text');
      const numberBg = document.querySelector('#number-bg');
      const crowdContainer = document.querySelector('#crowd-container');
      const crowdBg = document.querySelector('#crowd-bg');
      const crowdTitle = document.querySelector('#crowd-title');
      const schoolsContainer = document.querySelector('#schools-container');
      const schoolsBg = document.querySelector('#schools-bg');
      const schoolsTitle = document.querySelector('#schools-title');
      const podiumContainer = document.querySelector('#podium-container');
      const podiumBg = document.querySelector('#podium-bg');
      const podiumTitle = document.querySelector('#podium-title');
      const welcomeBg = document.querySelector('#welcome-bg');
      const welcomeTitle = document.querySelector('#welcome-title');
      const welcomeSubtitle = document.querySelector('#welcome-subtitle');
      const startButton = document.querySelector('#start-button');
      const startText = document.querySelector('#start-text');
      
      let animationRunning = false;
      let menuActive = false;

      const showElement = (el, animation) => {
        el.setAttribute('visible', true);
        if (animation) el.setAttribute('animation', animation);
      };
      
      const hideElement = (el) => el.setAttribute('visible', false);
      
      // Fonctions pour afficher/cacher les sphères principales
      const showSpheres = () => {
        showElement(sphereEl, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
        showElement(statusSphere, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
        showElement(schoolSphere, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
        showElement(podiumSphere, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; easing: easeOutBack');
      };
      
      // Fonctions pour cacher les sphères principales
      const hideSpheres = () => {
        hideElement(sphereEl);
        hideElement(statusSphere);
        hideElement(schoolSphere);
        hideElement(podiumSphere);
      };
      
      targetEl.addEventListener('targetFound', () => {
        if (!menuActive) {
          showElement(welcomeBg, 'property: opacity; from: 0; to: 0.95; dur: 500');
          showElement(welcomeTitle, 'property: opacity; from: 0; to: 1; dur: 600; delay: 100');
          showElement(welcomeSubtitle, 'property: opacity; from: 0; to: 1; dur: 600; delay: 200');
          showElement(startButton, 'property: scale; from: 0 0 0; to: 1 1 1; dur: 500; delay: 300; easing: easeOutBack');
          showElement(startText, 'property: opacity; from: 0; to: 1; dur: 500; delay: 300');
        } else {
          showSpheres();
        }
      });
      // Cacher tous les éléments lorsque la cible est perdue
      targetEl.addEventListener('targetLost', () => {
        [sphereEl, statusSphere, schoolSphere, podiumSphere, titleText, textBg, numberText, 
         numberBg, crowdContainer, crowdBg, crowdTitle, schoolsContainer, schoolsBg, schoolsTitle, podiumContainer, podiumBg, podiumTitle, welcomeBg, welcomeTitle, welcomeSubtitle, 
         startButton, startText]
          .forEach(hideElement);
      });

      // Démarrer l'expérience "DECOUVRIR" 
      startButton.addEventListener('click', () => {
        menuActive = true;
        [welcomeBg, welcomeTitle, welcomeSubtitle, startButton, startText].forEach(hideElement);
        showSpheres();
      });

      // Animation pour le nombre d'étudiants et apprentis
      sphereEl.addEventListener('click', () => {
        if (!menuActive || animationRunning) return;
        animationRunning = true;

        hideSpheres(); // Cacher les sphères principales
        
        // Reset des valeurs initiales
        titleText.setAttribute('value', 'En 2015');
        numberText.setAttribute('value', 'Etudiants : 2344');
        hatEntity.setAttribute('scale', '0.03 0.03 0.03');
        
        showElement(textBg, 'property: opacity; from: 0; to: 0.9; dur: 500');
        showElement(titleText, 'property: opacity; from: 0; to: 1; dur: 500');
        showElement(numberBg, 'property: opacity; from: 0; to: 0.9; dur: 500');
        showElement(numberText, 'property: opacity; from: 0; to: 1; dur: 500; color: #9ED5D8');
        showElement(hatEntity);
        hatEntity.setAttribute('animation', 'property: scale; to: 0.15 0.15 0.15; dur: 2000; easing: easeOutQuad');
        // Chamgement pour 2020
        setTimeout(() => {
          titleText.setAttribute('value', 'En 2020');
          numberText.setAttribute('value', 'Etudiants : 2758');
          hatEntity.setAttribute('animation', 'property: scale; to: 0.28 0.28 0.28; dur: 2000; easing: easeOutQuad');
        }, 3000);
        // Changement pour 2025
        setTimeout(() => {
          titleText.setAttribute('value', 'En 2025');
          numberText.setAttribute('value', 'Etudiants : 2747');
          hatEntity.setAttribute('animation', 'property: scale; to: 0.38 0.38 0.38; dur: 2000; easing: easeOutQuad; color: #9ED5D8');
        }, 6000);
        // Dernier changement avec le nombre actuel
        setTimeout(() => {
          titleText.setAttribute('value', 'Maintenant');
          numberText.setAttribute('value', 'Etudiants : 3675');
          hatEntity.setAttribute('animation', 'property: scale; to: 0.48 0.48 0.48; dur: 2000; easing: easeOutQuad; color: #9ED5D8');
        }, 9000);
        // Fin de l'animation après le dernier changement
        setTimeout(() => {
          [hatEntity, titleText, textBg, numberText, numberBg].forEach(hideElement);
          showSpheres();
          animationRunning = false;
        }, 13000);
      });
      
      statusSphere.addEventListener('click', () => {
        if (!menuActive || animationRunning) return;
        animationRunning = true;
        
        hideSpheres();
        showElement(crowdBg, 'property: opacity; from: 0; to: 0.95; dur: 500');
        showElement(crowdTitle, 'property: opacity; from: 0; to: 1; dur: 500');
        
        crowdContainer.innerHTML = '';
        showElement(crowdContainer);
        
        const positions = [-0.9, -0.3, 0.3, 0.9];
        // Animation d'apparition des étudians et apprentis
        positions.forEach((x, index) => {
          setTimeout(() => {
            const model = document.createElement('a-entity');
            const modelId = index === 3 ? '#suit-model' : '#student-model'; // Le 4ème modèle est un apprenti
            model.setAttribute('gltf-model', modelId);
            model.setAttribute('position', `${x} 0 0`);
            model.setAttribute('scale', '0.17 0.17 0.17');
            model.setAttribute('animation', 'property: scale; from: 0 0 0; to: 0.17 0.17 0.17; dur: 800; easing: easeOutBack');
            crowdContainer.appendChild(model);
            
            // Add label above the model
            const label = document.createElement('a-text');
            const labelText = index === 3 ? 'APPRENTIS' : 'ETUDIANT';
            label.setAttribute('value', labelText);
            label.setAttribute('align', 'center');
            label.setAttribute('position', `${x} 0.3 0`);
            label.setAttribute('scale', '0.28 0.28 0.28');
            label.setAttribute('color', '#ffffff');
            label.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 800');
            crowdContainer.appendChild(label);
          }, index * 400);
        });

        // Fin de l'animation après le dernier élément
        setTimeout(() => {
          [crowdContainer, crowdBg, crowdTitle].forEach(hideElement);
          showSpheres();
          animationRunning = false;
        }, 6000);
      });

      // Animation pour le statut des établissements
      schoolSphere.addEventListener('click', () => {
        if (!menuActive || animationRunning) return;
        animationRunning = true;
        
        hideSpheres();
        showElement(schoolsBg, 'property: opacity; from: 0; to: 0.92; dur: 500');
        showElement(schoolsTitle, 'property: opacity; from: 0; to: 1; dur: 500');
        
        schoolsContainer.innerHTML = '';
        showElement(schoolsContainer);
        
        // Affichage simple des 3 types d'établissements
        const schoolsData = [
          { position: '-0.6 0 0', color: '#2397A3', label: 'Public', number: '8' },
          { position: '0 0 0', color: '#13525C', label: 'Prive\nsous contrat', number: '3' },
          { position: '0.6 0 0', color: '#DA1615', label: 'Prive\nsans contrat', number: '10' }
        ];
        
        schoolsData.forEach((data, index) => {
          setTimeout(() => {
            // Créer le modèle 3D de l'école
            const school = document.createElement('a-entity');
            school.setAttribute('gltf-model', '#school-model');
            school.setAttribute('position', `${data.position.split(' ')[0]} 0.1 0`);
            school.setAttribute('scale', '0.005 0.005 0.005');
            school.setAttribute('animation', 'property: scale; from: 0 0 0; to: 0.005 0.005 0.005; dur: 800; easing: easeOutBack');
            schoolsContainer.appendChild(school);
            
            // Ajouter le fond coloré
            const bg = document.createElement('a-plane');
            bg.setAttribute('position', data.position);
            bg.setAttribute('width', '0.5');
            bg.setAttribute('height', '0.6');
            bg.setAttribute('color', data.color);
            bg.setAttribute('opacity', '0.8');
            bg.setAttribute('animation', 'property: opacity; from: 0; to: 0.8; dur: 800');
            schoolsContainer.appendChild(bg);
            
            // Ajouter le label
            const label = document.createElement('a-text');
            label.setAttribute('value', data.label);
            label.setAttribute('align', 'center');
            label.setAttribute('position', `${data.position.split(' ')[0]} -0.15 0.05`);
            label.setAttribute('scale', '0.3 0.3 0.3');
            label.setAttribute('color', '#ffffff');
            label.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 800; delay: 200');
            schoolsContainer.appendChild(label);
            
            // Ajouter le nombre
            const number = document.createElement('a-text');
            number.setAttribute('value', data.number);
            number.setAttribute('align', 'center');
            number.setAttribute('position', `${data.position.split(' ')[0]} -0.35 0.05`);
            number.setAttribute('scale', '0.6 0.6 0.6');
            number.setAttribute('color', '#ffffff');
            number.setAttribute('font', 'roboto');
            number.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 800; delay: 400');
            schoolsContainer.appendChild(number);
          }, index * 400);
        });
        
        setTimeout(() => {
          [schoolsContainer, schoolsBg, schoolsTitle].forEach(hideElement);
          showSpheres();
          animationRunning = false;
        }, 6000);
      });
      
      podiumSphere.addEventListener('click', () => {
        if (!menuActive || animationRunning) return;
        animationRunning = true;
        
        hideSpheres();
        showElement(podiumBg, 'property: opacity; from: 0; to: 0.92; dur: 500');
        showElement(podiumTitle, 'property: opacity; from: 0; to: 1; dur: 500');
        
        podiumContainer.innerHTML = '';
        showElement(podiumContainer);
        
        // Création du podium avec 3 boîtes
        const podiumData = [
          { position: '-0.35 -0.15 0', height: 0.4, color: '#2397a3', rank: '2', label: 'IUT BEZIERS', image: '#ruffel' },  // 2ème place (gauche)
          { position: '0 0 0', height: 0.6, color: '#9ed5d8', rank: '1', label: 'UNIVERSITE', image: '#purple' },         // 1ère place (centre)
          { position: '0.35 -0.25 0', height: 0.3, color: '#13525c', rank: '3', label: 'LYCEE MERMOZ', image: '#supexup' }  // 3ème place (droite)
        ];
        
        podiumData.forEach((data, index) => {
          setTimeout(() => {
            // Créer la boîte du podium
            const box = document.createElement('a-box');
            box.setAttribute('position', data.position);
            box.setAttribute('width', '0.35');
            box.setAttribute('height', data.height);
            box.setAttribute('depth', '0.35');
            box.setAttribute('color', data.color);
            box.setAttribute('animation', `property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutBack`);
            podiumContainer.appendChild(box);
            
            // Ajouter l'image sur le haut de la marche
            const logo = document.createElement('a-plane');
            logo.setAttribute('src', data.image);
            logo.setAttribute('position', `${data.position.split(' ')[0]} ${parseFloat(data.position.split(' ')[1]) + data.height/2 + 0.15} 0.2`);
            logo.setAttribute('width', '0.25');
            logo.setAttribute('height', '0.25');
            logo.setAttribute('transparent', 'true');
            logo.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 800; delay: 200');
            podiumContainer.appendChild(logo);
            
            // Ajouter le numéro de rang au-dessus de l'image
            const rankText = document.createElement('a-text');
            rankText.setAttribute('value', data.rank);
            rankText.setAttribute('align', 'center');
            rankText.setAttribute('position', `${data.position.split(' ')[0]} ${parseFloat(data.position.split(' ')[1]) + data.height/2 + 0.35} 0.2`);
            rankText.setAttribute('scale', '0.5 0.5 0.5');
            rankText.setAttribute('color', '#ffffff');
            rankText.setAttribute('animation', 'property: opacity; from: 0; to: 1; dur: 800');
            podiumContainer.appendChild(rankText);
          }, index * 400);
        });
        
        setTimeout(() => {
          [podiumContainer, podiumBg, podiumTitle].forEach(hideElement);
          showSpheres();
          animationRunning = false;
        }, 6000);
      });
    </script>
  </body>
</html>